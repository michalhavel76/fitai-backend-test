// =======================================================
// FitAI 4.9 ‚Äì Scientific Run Engine
// Full Automatic Cycle: Correction ‚Üí Calibration ‚Üí Summary
// Compatible with existing FitAI 4.8 backend
// =======================================================

import { Pool } from "pg";
import scientificCorrection from "./scientific-correction.js";
import { scientificCalibrate } from "./scientific-calibration.js";

const pool = new Pool({
  connectionString: process.env.DATABASE_URL,
  ssl: { rejectUnauthorized: false },
});

// =======================================================
// üß¨ MAIN ENGINE
// =======================================================
const scientificRun = async (req, res) => {
  console.log("üöÄ Starting FitAI Scientific Run 4.9...");
  const client = await pool.connect();

  const batchStart = new Date();
  const batchId = `run_${batchStart.toISOString()}`;

  try {
    // ‚úÖ Step 1 ‚Äì Run correction
    console.log("üß™ Step 1: Running scientific correction...");
    const correctionResult = await new Promise((resolve, reject) => {
      // Simulace vol√°n√≠ endpointu bez HTTP
      const mockRes = {
        json: (data) => resolve(data),
        status: () => ({ json: (err) => reject(err) }),
      };
      scientificCorrection({}, mockRes);
    });

    // ‚úÖ Step 2 ‚Äì Run calibration
    console.log("üî¨ Step 2: Running scientific calibration...");
    const calibrationResult = await new Promise((resolve, reject) => {
      const mockRes = {
        json: (data) => resolve(data),
        status: () => ({ json: (err) => reject(err) }),
      };
      scientificCalibrate({}, mockRes);
    });

    // ‚úÖ Step 3 ‚Äì Calculate improvement
    const improvement =
      (Number(calibrationResult.averageAccuracy || 0) -
        Number(req.body.prevAccuracy || 0)) *
      100;

    // ‚úÖ Step 4 ‚Äì Save batch summary
    await client.query(
      `INSERT INTO food_audit_log (action, details, created_at)
       VALUES ($1, $2, NOW())`,
      [
        "scientific_batch",
        JSON.stringify({
          batchId,
          correction: correctionResult,
          calibration: calibrationResult,
          improvement: `${improvement.toFixed(2)}%`,
        }),
      ]
    );

    const summary = {
      success: true,
      batchId,
      correction: correctionResult,
      calibration: calibrationResult,
      improvement: `${improvement.toFixed(2)}%`,
      message: "Full scientific batch completed successfully",
      date: new Date().toISOString(),
    };

    console.log("‚úÖ Scientific Run 4.9 finished:", summary);
    res.json(summary);
  } catch (err) {
    console.error("‚ùå Scientific Run error:", err);
    res.status(500).json({ error: "Scientific run failed", details: err.message });
  } finally {
    client.release();
  }
};

// =======================================================
// ‚úÖ Default export (compatible with index.ts import)
// =======================================================
export default scientificRun;
